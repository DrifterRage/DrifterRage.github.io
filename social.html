<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TwoRoadsDayZ — Community Feed</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="assets/style.css" rel="stylesheet">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TPFMB30C0P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-TPFMB30C0P');
  </script>
</head>
<body>
  <!-- Scroll Indicator -->
  <div class="scroll-indicator"><div class="scroll-progress"></div></div>
  <!-- Background Particles -->
  <div class="particles"></div>

  <!-- Navigation -->
  <nav id="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">TwoRoadsDayZ</a>
      <ul class="nav-links">
        <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
        <li><a href="join.html"><i class="fas fa-server"></i> Join</a></li>
        <li><a href="store.html"><i class="fas fa-shopping-cart"></i> Store</a></li>
        <li><a href="about.html"><i class="fas fa-info"></i> About</a></li>
        <li><a href="contact.html"><i class="fas fa-envelope"></i> Contact</a></li>
        <li><a href="social.html"><i class="fas fa-users"></i> Community</a></li>
        <li><a href="media.html"><i class="fas fa-play"></i> Media</a></li>
      </ul>
    </div>
  </nav>

  <!-- Page Header -->
  <section class="hero" id="top">
    <div class="hero-content">
      <h1>Your Feed</h1>
      <p>Share your latest survival stories.</p>
    </div>
  </section>

  <!-- Composer -->
  <section>
    <div class="container">
      <div class="contact-form fade-in" style="max-width:800px;margin:0 auto;">
        <div class="form-group">
          <label for="handle">Your Handle (optional)</label>
          <input id="handle" placeholder="e.g., Snipes">
        </div>

        <div class="form-group">
          <label for="postText">New Post</label>
          <textarea id="postText" placeholder="Share what just happened..."></textarea>
        </div>

        <button class="submit-btn" id="postBtn"><i class="fas fa-plus"></i> Post</button>
      </div>

      <div class="section-divider"></div>

      <!-- Feed -->
      <div id="feed" class="staff-grid"></div>
    </div>
  </section>

  <!-- Floating Action Button -->
  <a href="#top" class="fab"><i class="fas fa-chevron-up"></i></a>

  <!-- Global site JS -->
  <script src="assets/script.js"></script>

  <!-- Firestore-powered Social Feed -->
  <script type="module">
    /************************************
     * TwoRoadsDayZ - Firestore Social (with Auth)
     * Works on GitHub Pages via CDN imports
     ************************************/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp,
      doc, updateDoc, increment, deleteDoc, getDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';

    // 🔧 Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDtu5RX7ZR6xU9EfUAq9_jmgQp_2aS08N4",
      authDomain: "tworoadsdayzmediashare.firebaseapp.com",
      projectId: "tworoadsdayzmediashare",
      storageBucket: "tworoadsdayzmediashare.firebasestorage.app",
      messagingSenderId: "1071182717113",
      appId: "1:1071182717113:web:e5d3f7b23997cc58087b68"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // 🔐 Anonymous Auth (gives each visitor a uid)
    const auth = getAuth();
    let currentUid = null;
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user) => { currentUid = user?.uid || null; });

    // DOM refs
    const feedEl      = document.getElementById('feed');
    const txt         = document.getElementById('postText');
    const btn         = document.getElementById('postBtn');
    const handleInput = document.getElementById('handle');

    // remember handle locally
    const USER_KEY = 'trd_user_handle';
    if (handleInput) handleInput.value = localStorage.getItem(USER_KEY) || '';
    handleInput?.addEventListener('input', () => {
      localStorage.setItem(USER_KEY, handleInput.value.trim());
    });

    // rate limit to deter spam
    const LAST_POST_KEY = 'trd_last_post_ts';
    function rateLimited(ms=8000) {
      const last = Number(localStorage.getItem(LAST_POST_KEY) || 0);
      const now  = Date.now();
      if (now - last < ms) return true;
      localStorage.setItem(LAST_POST_KEY, String(now));
      return false;
    }

    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function toDate(ts) {
      return ts?.seconds ? new Date(ts.seconds * 1000) : new Date();
    }

    // Create post
    btn?.addEventListener('click', async () => {
      const text   = (txt?.value || '').trim();
      const author = (handleInput?.value || '').trim();
      if (!text) return;
      if (rateLimited()) { alert('Slow down a sec before posting again 🙂'); return; }

      try {
        if (handleInput) localStorage.setItem(USER_KEY, author);
        await addDoc(collection(db, 'posts'), {
          content: text,                 // standardized to `content` (not `text`)
          author,
          uid: currentUid,               // who posted
          likes: 0,
          commentsCount: 0,
          createdAt: serverTimestamp()   // standardized to `createdAt` (for rules)
        });
        if (txt) txt.value = '';
        await loadFeed();

        if (typeof gtag !== 'undefined') {
          gtag('event','submit',{event_category:'Social',event_label:'Post_Submit'});
        }
      } catch (err) {
        console.error('Error adding post:', err);
        alert('Failed to post. Try again?');
      }
    });

    // Load comments for a post
    async function loadComments(postId) {
      const list = document.querySelector(`[data-c-list="${postId}"]`);
      if (!list) return;
      const q = query(collection(db, 'posts', postId, 'comments'), orderBy('createdAt', 'asc'));
      const snap = await getDocs(q);
      if (snap.empty) {
        list.innerHTML = '<div class="server-info" style="opacity:.7">No comments yet.</div>';
        return;
      }
      list.innerHTML = snap.docs.map(d => {
        const c = d.data();
        return `
          <div class="server-info" style="margin:.5rem 0;">
            <strong>${escapeHtml(c.author || 'Survivor')}</strong>
            <span style="opacity:.7; margin-left:.5rem;">${toDate(c.createdAt).toLocaleString()}</span>
            <div style="margin-top:.25rem;">${escapeHtml(c.text || '')}</div>
          </div>
        `;
      }).join('');
    }

    // Like / Delete / Toggle comments / Add comment
    feedEl?.addEventListener('click', async (e) => {
      const likeBtn   = e.target.closest('button[data-like]');
      const delBtn    = e.target.closest('button[data-del]');
      const toggleBtn = e.target.closest('button[data-toggle-comments]');
      const addCBtn   = e.target.closest('button[data-c-post]');

      try {
        if (likeBtn) {
          const id = likeBtn.getAttribute('data-like');
          await updateDoc(doc(db, 'posts', id), { likes: increment(1) });
          const span = likeBtn.querySelector('[data-like-count]');
          if (span) span.textContent = String(Number(span.textContent || '0') + 1);
          return;
        }

        if (toggleBtn) {
          const id  = toggleBtn.getAttribute('data-toggle-comments');
          const box = document.querySelector(`[data-comments="${id}"]`);
          if (!box) return;
          const show = box.style.display !== 'block';
          box.style.display = show ? 'block' : 'none';
          if (show) await loadComments(id);
          return;
        }

        if (addCBtn) {
          const id      = addCBtn.getAttribute('data-c-post');
          const hInput  = document.querySelector(`[data-c-handle="${id}"]`);
          const tInput  = document.querySelector(`[data-c-text="${id}"]`);
          const author  = (hInput?.value || '').trim() || 'Survivor';
          const text    = (tInput?.value || '').trim();
          if (!text) return;

          await addDoc(collection(db, 'posts', id, 'comments'), {
            author,
            text,
            uid: currentUid,
            likes: 0,
            createdAt: serverTimestamp()
          });
          await updateDoc(doc(db, 'posts', id), { commentsCount: increment(1) });
          if (tInput) tInput.value = '';
          await loadComments(id);

          const cCount = document.querySelector(`button[data-toggle-comments="${id}"] [data-c-count]`);
          if (cCount) cCount.textContent = String(Number(cCount.textContent || '0') + 1);
          return;
        }

        if (delBtn) {
          const id  = delBtn.getAttribute('data-del');
          const ref = doc(db, 'posts', id);
          const myHandle = (localStorage.getItem(USER_KEY) || '').trim().toLowerCase();

          const snap = await getDoc(ref);
          const post = snap.exists() ? snap.data() : null;
          const owner = (post?.author || '').trim().toLowerCase();

          // Soft client check by handle (final enforcement happens in rules)
          if (owner && myHandle !== owner) {
            const ok = confirm('Handle does not match post author. Delete anyway?');
            if (!ok) return;
          }
          await deleteDoc(ref);
          await loadFeed();
          return;
        }
      } catch (err) {
        console.error('Action error:', err);
        alert('Action failed. Try again?');
      }
    });

    // Load feed
    async function loadFeed() {
      if (!feedEl) return;
      feedEl.innerHTML = '';

      const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);

      if (snap.empty) {
        feedEl.innerHTML = '<div class="server-info" style="opacity:.7">No posts yet. Be the first survivor to report in.</div>';
        return;
      }

      snap.forEach(docSnap => {
        const p = docSnap.data();
        const id = docSnap.id;
        const card = document.createElement('div');
        card.className = 'staff-card fade-in visible';
        card.innerHTML = `
          <div class="staff-avatar"><i class="fas fa-user"></i></div>
          <h3>${escapeHtml(p.author || 'Survivor')}</h3>
          <div class="staff-role">${toDate(p.createdAt).toLocaleString()}</div>
          <div class="staff-bio">${escapeHtml(p.content || '')}</div>

          <div style="display:flex; gap:.5rem; margin-top:.75rem;">
            <button class="buy-btn" data-like="${id}">
              👍 <span data-like-count>${Number(p.likes || 0)}</span>
            </button>
            <button class="buy-btn" data-toggle-comments="${id}">
              Comments (<span data-c-count>${Number(p.commentsCount || 0)}</span>)
            </button>
            <button class="buy-btn" data-del="${id}">Delete</button>
          </div>

          <div class="contact-form" data-comments="${id}" style="display:none; margin-top:1rem;">
            <div class="form-group">
              <input data-c-handle="${id}" placeholder="Your handle (optional)">
            </div>
            <div class="form-group">
              <textarea data-c-text="${id}" placeholder="Write a comment..."></textarea>
            </div>
            <button class="submit-btn" data-c-post="${id}">
              <i class="fas fa-comment"></i> Add Comment
            </button>
            <div data-c-list="${id}" style="margin-top:1rem;"></div>
          </div>
        `;
        feedEl.appendChild(card);
      });
    }

    // initial load
    loadFeed();
  </script>
</body>
</html>
